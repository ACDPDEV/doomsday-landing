---
interface Props {
    id: number;
    videoId: string;
    background: string;
    characters: { name: string; image: string | null }[];
    lang?: "en" | "es";
}

const { id, videoId, background, characters, lang = "en" } = Astro.props;

const labels = {
    en: {
        views: "views",
        likes: "likes",
        play: "Watch Trailer",
    },
    es: {
        views: "vistas",
        likes: "me gusta",
        play: "Ver Trailer",
    },
};

const t = labels[lang];
---

<section
    class="relative min-h-screen flex flex-col items-center justify-center overflow-hidden"
    data-trailer-section
    data-video-id={videoId}
    data-trailer-id={id}
>
    <div class="absolute inset-0 z-0">
        <img
            src={`/assets/backgrounds/${background}`}
            alt={`Trailer ${id} Background`}
            class="w-full h-full object-cover"
        />
        <div class="absolute inset-0 bg-black/60"></div>
    </div>

    <div class="relative z-10 w-full max-w-6xl px-6 py-12">
        <div
            class="flex flex-col md:flex-row items-center justify-between gap-8"
        >
            <div class="flex-1">
                <h2 class="text-4xl md:text-5xl font-bold mb-4 text-white">
                    Trailer {id}
                </h2>

                <div class="flex items-center gap-6 mb-6">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl font-bold" data-views>---</span>
                        <span class="text-gray-300">{t.views}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span>üëç</span>
                        <span class="text-2xl font-bold" data-likes>---</span>
                        <span class="text-gray-300">{t.likes}</span>
                    </div>
                </div>

                <div
                    class="inline-flex items-center gap-3 bg-red-600 hover:bg-red-700 text-white px-8 py-4 rounded-lg text-xl font-bold transition-colors"
                >
                    <img
                        src="/assets/icons/play.svg"
                        alt="Play"
                        class="w-8 h-8"
                    />
                    {t.play}
                </div>
            </div>
        </div>

        <div class="flex flex-wrap justify-center gap-4">
            {
                characters.map((char) => (
                    <div class="flex flex-col items-center">
                        {char.image && (
                            <img
                                src={`/assets/characters/${char.image}`}
                                alt={char.name}
                                class="w-20 h-20 md:w-24 md:h-24 object-contain rounded-full bg-black/40"
                            />
                        )}

                        <span class="mt-2 text-sm text-center text-gray-300">
                            {char.name}
                        </span>
                    </div>
                ))
            }
        </div>
    </div>
</section>

<script>
    async function fetchYouTubeStats(section: HTMLElement) {
        const videoId = section.dataset.videoId;
        const trailerId = section.dataset.trailerId;

        if (!videoId) {
            console.error("No videoId found");
            return;
        }

        try {
            const response = await fetch(`/api/youtube?id=${videoId}`);
            const data = await response.json();

            const viewsEl = section.querySelector("[data-views]");
            const likesEl = section.querySelector("[data-likes]");

            if (viewsEl && data.views) {
                viewsEl.textContent = new Intl.NumberFormat().format(
                    data.views,
                );
            }
            if (likesEl && data.likes) {
                likesEl.textContent = new Intl.NumberFormat().format(
                    data.likes,
                );
            }
        } catch (error) {
            console.error("Error fetching YouTube stats:", error);
            const viewsEl = section.querySelector("[data-views]");
            const likesEl = section.querySelector("[data-likes]");
            if (viewsEl) viewsEl.textContent = "---";
            if (likesEl) likesEl.textContent = "---";
        }
    }

    // Inicializar todas las secciones de trailers
    document.querySelectorAll("[data-trailer-section]").forEach((section) => {
        fetchYouTubeStats(section as HTMLElement);
    });
</script>
